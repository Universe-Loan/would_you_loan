<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- ì‚¬ìš©ì ì •ì˜ CSS -->
    <link rel="stylesheet" href="/css/common.css">
</head>
<style>
    .box {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .article-box {
        padding: 10px 0; /* ê°„ê²© ì¶”ê°€ */
        border-bottom: 1px solid #e0e0e0; /* í•˜ë‹¨ êµ¬ë¶„ì„  */
    }

    .article-box .row {
        display: flex;
        align-items: center;
    }

    .article-box a {
        color: black; /* ë§í¬ ìƒ‰ìƒ */
        text-decoration: none; /* ë°‘ì¤„ ì œê±° */
        transition: color 0.3s ease; /* ìƒ‰ìƒ ì „í™˜ íš¨ê³¼ */
    }

    .article-box a:hover {
        color: #007bff; /* ë§ˆìš°ìŠ¤ í˜¸ë²„ ì‹œ ìƒ‰ìƒ */
        text-decoration: underline; /* ë°‘ì¤„ ì¶”ê°€ */
    }
    /* í”Œë¡œíŒ… ë²„íŠ¼ */
    #chat-floating-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }

    .chat-button {
        width: 60px;
        height: 60px;
    }

    /* ì±„íŒ…ì°½ */
    .chat-container {
        display: none;
        position: fixed;
        bottom: 80px;
        right: 20px;
        z-index: 1000;
        width: 600px;
        max-height: 800px;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        background-color: white;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
    }

    .chat-header {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
        background-color: #f8f9fa;
    }

    .chat-messages {
        padding: 10px;
        overflow-y: auto;
        height: 600px;
    }

    .chat-footer {
        padding: 10px;
        border-top: 1px solid #dee2e6;
        display: flex;
        gap: 10px;
    }

    .chat-footer .form-control {
        flex: 1;
    }

    /* ë¡œë”© ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
    .loading-icon {
        display: inline-block;
        width: 1em;
        height: 1em;
        border: 2px solid rgba(0, 0, 0, 0.2);
        border-top-color: #007bff;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

</style>
<body>

<!--í—¤ë”-->
<header th:replace="fragments/header :: nav"></header>

<!--ë³¸ë¬¸-->
<div class="content-wrapper">
    <!-- í”Œë¡œíŒ… ë²„íŠ¼ -->
    <div id="chat-floating-button">
        <button class="btn btn-primary rounded-circle chat-button">ğŸ’¬</button>
    </div>

    <!-- ì±„íŒ…ì°½ -->
    <div id="chat-container" class="chat-container">
        <div class="chat-header">
            <span>ì±„íŒ…</span>
            <button id="close-chat" class="btn btn-sm btn-outline-secondary float-end">ë‹«ê¸°</button>
        </div>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="chat-footer">
            <input type="text" id="chat-input" class="form-control" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”" required>
            <button id="send-button" class="btn btn-primary">ì „ì†¡</button>
        </div>
    </div>
</div>



    <!--ë³¸ë¬¸ ë‚´ìš© ì…ë ¥í•˜ê¸°-->
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-6">
                <div class="box">ì§€í‘œ 1</div>
            </div>
            <div class="col-md-6">
                <div class="box">ì§€í‘œ 2</div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="box">ì§€í‘œ 3</div>
            </div>
            <div class="col-md-6">
                <div class="box">ì§€í‘œ 4</div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="box">ë¶€ë™ì‚° ë‚ ì”¨</div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="box">ê¸°ì‚¬ ê°ì • ë¶„ì„
                    <div class="row">
                        <div class="col-12">
                            <div class="article-list">
                                <div th:each="article : ${articles}" class="article-box">
                                    <div class="row align-items-center">
                                        <div class="col-6">
                                            <a th:text="${article.title}" th:href="${article.url}" target="_blank"></a>
                                        </div>
                                        <div class="col-3 text-center">
                                            <span th:text="${article.articleDate}"></span>
                                        </div>
                                        <div class="col-3 text-end">
                                            <span th:text="${article.company}"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
                    <div class="pagination mt-4 justify-content-center">
                        <ul class="pagination justify-content-center">
                            <!-- ì´ì „ ë²„íŠ¼ -->
                            <li class="page-item" th:if="${currentPage > 0}">
                                <a class="page-link" th:href="@{/market-analysis(page=${currentPage - 1}, size=10)}">ì´ì „</a>
                            </li>

                            <!-- í˜ì´ì§€ ë²ˆí˜¸ -->
                            <li class="page-item" th:each="pageNum : ${#numbers.sequence(startPage, endPage)}"
                                th:classappend="${pageNum == currentPage} ? 'active'">
                                <a class="page-link" th:href="@{/market-analysis(page=${pageNum}, size=10)}"
                                   th:text="${pageNum + 1}"></a>
                            </li>

                            <!-- ë‹¤ìŒ ë²„íŠ¼ -->
                            <li class="page-item" th:if="${currentPage < totalPages - 1}">
                                <a class="page-link" th:href="@{/market-analysis(page=${currentPage + 1}, size=10)}">ë‹¤ìŒ</a>
                            </li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </div>

</div>

<!--footer-->
<footer th:replace="fragments/footer :: footer"></footer>

<!--Javascript-->
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const floatingButton = document.getElementById("chat-floating-button");
        const chatContainer = document.getElementById("chat-container");
        const closeChatButton = document.getElementById("close-chat");
        const chatForm = document.getElementById("chat-form");
        const chatInput = document.getElementById("chat-input");
        const sendButton = document.getElementById("send-button");
        const chatMessages = document.getElementById("chat-messages");

        // í”Œë¡œíŒ… ë²„íŠ¼ í´ë¦­ ì‹œ ì±„íŒ…ì°½ í† ê¸€
        floatingButton.addEventListener("click", () => {
            chatContainer.style.display = chatContainer.style.display === "none" ? "block" : "none";
        });

        // ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ì±„íŒ…ì°½ ìˆ¨ê¸°ê¸°
        closeChatButton.addEventListener("click", () => {
            chatContainer.style.display = "none";
        });

        // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
        function sendMessage() {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            addMessage("user", userMessage);

            // ë¡œë”© ì¤‘ ë©”ì‹œì§€ í‘œì‹œ (ì•„ì´ì½˜ í¬í•¨)
            const loadingMessage = addMessage("bot", '<span class="loading-icon"></span> ë¡œë”© ì¤‘...');

            // API ìš”ì²­
            fetch("/rag/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    user_id: "1", // ì‹¤ì œ ì‚¬ìš©ì IDë¡œ êµì²´ í•„ìš”
                    user_question: userMessage
                })
            })
                .then(response => response.json())
                .then(data => {
                    // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                    removeMessage(loadingMessage);

                    // ì„œë²„ ì‘ë‹µ ë°ì´í„° í‘œì‹œ
                    const { answer, title, article_date, company, url } = data;
                    addMessage("bot", `${answer}`);
                    if (title) {
                        addMessage("bot", `ê´€ë ¨ ê¸°ì‚¬: ${title} (${company}, ${article_date}) <a href="${url}" target="_blank">[ë§í¬]</a>`);
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    removeMessage(loadingMessage);
                    addMessage("bot", "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                });

            // ì…ë ¥ì°½ ë¹„ìš°ê¸°
            chatInput.value = "";
        }

        // ì „ì†¡ ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ì‹œì§€ ì „ì†¡
        sendButton.addEventListener("click", sendMessage);

        // ì—”í„° í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
        chatInput.addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                sendMessage();
            }
        });

        // ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
        function addMessage(sender, message) {
            const messageBubble = document.createElement("div");
            messageBubble.style.marginBottom = "10px";
            messageBubble.style.padding = "10px";
            messageBubble.style.borderRadius = "10px";

            if (sender === "user") {
                messageBubble.style.backgroundColor = "#d1ecf1";
                messageBubble.style.alignSelf = "flex-end";
            } else {
                messageBubble.style.backgroundColor = "#f8f9fa";
                messageBubble.style.alignSelf = "flex-start";
            }

            messageBubble.innerHTML = message;
            chatMessages.appendChild(messageBubble);
            chatMessages.scrollTop = chatMessages.scrollHeight; // ìŠ¤í¬ë¡¤ì„ ìµœì‹  ë©”ì‹œì§€ë¡œ ì´ë™
            return messageBubble; // ë©”ì‹œì§€ ì—˜ë¦¬ë¨¼íŠ¸ ë°˜í™˜
        }

        // ë©”ì‹œì§€ë¥¼ ì œê±°í•˜ëŠ” í•¨ìˆ˜
        function removeMessage(messageElement) {
            if (messageElement && messageElement.parentNode) {
                messageElement.parentNode.removeChild(messageElement);
            }
        }
    });

</script>
<!-- ì‚¬ìš©ì ì •ì˜ JS -->
<script th:src="@{/js/home.js}"></script>
<th:block th:replace="fragments/header :: scripts"></th:block>
</body>
</html>