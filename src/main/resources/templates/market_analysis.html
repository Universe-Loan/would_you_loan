<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fonts-archive/Pretendard/Pretendard.css" type="text/css" />

    <!-- ì‚¬ìš©ì ì •ì˜ CSS -->
    <link rel="stylesheet" href="/css/common.css">

    <!--js-->

    <!--ì§€ë„ê·¸ë¦¬ê¸°-->
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<style>
    body {
        background-color: #f8f9fa;
    }
    .box {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 50px;
        margin-bottom: 20px;
    }
    .box-header {
        background-color: #0d6efd;
        color: white;
        font-weight: bold;
        font-size: large;
        display: flex;
        align-items: center;
    }
    .circle {
        width: 10px;
        height: 25px;
        border-radius: 20px;
        background-color: white;
        margin-right: 15px;
    }

    .article-box {
        padding: 10px 0; /* ê°„ê²© ì¶”ê°€ */
        border-bottom: 1px solid #e0e0e0; /* í•˜ë‹¨ êµ¬ë¶„ì„  */
    }

    .article-box a {
        color: black; /* ë§í¬ ìƒ‰ìƒ */
        text-decoration: none; /* ë°‘ì¤„ ì œê±° */
        transition: color 0.3s ease; /* ìƒ‰ìƒ ì „í™˜ íš¨ê³¼ */
    }

    .article-box a:hover {
        color: #007bff; /* ë§ˆìš°ìŠ¤ í˜¸ë²„ ì‹œ ìƒ‰ìƒ */
        text-decoration: underline; /* ë°‘ì¤„ ì¶”ê°€ */
    }
    /* í”Œë¡œíŒ… ë²„íŠ¼ */
    #chat-floating-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }

    .chat-button {
        width: 60px;
        height: 60px;
    }

    /* ì±„íŒ…ì°½ */
    .chat-container {
        display: none;
        position: fixed;
        bottom: 80px;
        right: 20px;
        z-index: 1000;
        width: 600px;
        max-height: 800px;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        background-color: white;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
    }

    .chat-header {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
        background-color: #f8f9fa;
    }

    .chat-messages {
        padding: 10px;
        overflow-y: auto;
        height: 600px;
    }

    .chat-footer {
        padding: 10px;
        border-top: 1px solid #dee2e6;
        display: flex;
        gap: 10px;
    }

    .chat-footer .form-control {
        flex: 1;
    }

    .region-button {
        width: 100%; /* ë²„íŠ¼ ì „ì²´ í­ */
        margin-bottom: 10px; /* ë²„íŠ¼ ê°„ê²© */
        text-align: center; /* í…ìŠ¤íŠ¸ ì •ë ¬ */
    }
    .region-button:hover {
        background-color: #f1f1f1;
        transition: background-color 0.3s ease-in-out;
    }

    /* ë¡œë”© ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
    .loading-icon {
        display: inline-block;
        width: 1em;
        height: 1em;
        border: 2px solid rgba(0, 0, 0, 0.2);
        border-top-color: #007bff;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

</style>
<body>

<!--í—¤ë”-->
<header th:replace="fragments/header :: nav"></header>

<!--ë³¸ë¬¸-->
<div class="content-wrapper">
    <!-- ì±—ë´‡ í”Œë¡œíŒ… ë²„íŠ¼ -->
    <div id="chat-floating-button">
        <button class="btn btn-primary rounded-circle chat-button">ğŸ’¬</button>
    </div>
    <!-- ì±—ë´‡ ì±„íŒ…ì°½ -->
    <div id="chat-container" class="chat-container">
        <div class="chat-header">
            <span>ì±„íŒ…</span>
            <button id="close-chat" class="btn btn-sm btn-outline-secondary float-end">ë‹«ê¸°</button>
        </div>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="chat-footer">
            <input type="text" id="chat-input" class="form-control" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”" required>
            <button id="send-button" class="btn btn-primary">ì „ì†¡</button>
        </div>
    </div>

    <!--ì‹œì¥ ì§„ë‹¨ í˜ì´ì§€-->
    <div class="container mt-4">
        <!-- ë¶€ë™ì‚° ì‹œì¥ ì§€í‘œ -->
        <div class="box box-header p-4">
            <span class="circle"></span>
            <div>ë¶€ë™ì‚° ì‹œì¥ ì§€í‘œ</div>
        </div>
        <div class="row flex-fill">
            <div class="col-md-6 d-flex flex-fill">
                <div class="box flex-fill d-flex justify-content-center align-items-center">ì§€í‘œ 1</div>
            </div>
            <div class="col-md-6 d-flex flex-fill">
                <div class="box flex-fill d-flex justify-content-center align-items-center">ì§€í‘œ 2</div>
            </div>
        </div>
        <div class="row flex-fill">
            <div class="col-md-6 d-flex flex-fill">
                <div class="box flex-fill d-flex justify-content-center align-items-center">
                    <h1>Market Analysis</h1>
                    <div class="chart-container">
                        <canvas id="marketChart" width="800" height="400"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6 d-flex flex-fill">
                <div class="box flex-fill d-flex justify-content-center align-items-center">ì§€í‘œ 4</div>
            </div>
        </div>

        <!-- ë¶€ë™ì‚° ë‚ ì”¨ -->
        <div class="box box-header p-4">
            <span class="circle"></span>
            <div>ì§€ì—­ë³„ ë¶€ë™ì‚° ë‚ ì”¨</div>
        </div>
        <div class="row flex-fill">
            <div class="col-12 d-flex flex-fill">
                <div class="box flex-fill d-flex justify-content-center align-items-center">
                    <div class="container">
                        <div class="row d-flex flex-wrap justify-content-center">
                            <div id="buttonContainer" class="col-md-3">
                                <!-- ì§€ì—­ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
                            </div>
                            <div class="col-md-9">
                                <svg id="weatherMap" style="width: 100%; min-height: 500px" class="border bg-white"></svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë¶€ë™ì‚° ì‹œì¥ ê¸°ì‚¬ -->
        <h5 class="box box-header p-4">
            <span class="circle"></span>
            <div>ë¶€ë™ì‚° ì‹œì¥ ê¸°ì‚¬</div>
        </h5>
        <div class="box">
            <!-- ê¸°ì‚¬ ë¦¬ìŠ¤íŠ¸-->
            <div class="article-list">
                <div th:each="article : ${articles}" class="article-box">
                    <div class="row align-items-center">
                        <!-- í–‰ì„± ì•„ì´ì½˜ -->
                        <div class="col-2 d-flex justify-content-center text-center">
                            <div th:if="${article.sentiment == 'ê¸ì •'}" class="d-flex align-items-start">
                                <img th:src="@{/img/planet_good.png}" alt="ê¸ì •" class="me-2" style="width: 24px; height: 24px;">
                                <span class="fw-bold mt-1" style="color: #dc3545">ì¢‹ì•„ìš”</span>
                            </div>
                            <div th:if="${article.sentiment == 'ë¶€ì •'}" class="d-flex align-items-start">
                                <img th:src="@{/img/planet_bad.png}" alt="ë¶€ì •" class="me-2" style="width: 24px; height: 24px;">
                                <span class="fw-bold mt-1" style="color: gray">ë‚˜ë¹ ìš”</span>
                            </div>
                        </div>
                        <!-- ê¸°ì‚¬ ì œëª© -->
                        <div class="col-6 text-start">
                            <a th:text="${article.title}" th:href="${article.url}" target="_blank" class="text-decoration-none"></a>
                        </div>
                        <!-- íšŒì‚¬ ì •ë³´ -->
                        <div class="col-2 text-end">
                            <span th:text="${article.company}"></span>
                        </div>
                        <!-- ê¸°ì‚¬ ë‚ ì§œ -->
                        <div class="col-2 text-center">
                            <span th:text="${article.articleDate}"></span>
                        </div>
                    </div>
                </div>

            </div>
            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            <div class="pagination mt-4 justify-content-center">
                <ul class="pagination justify-content-center">
                    <!-- ì´ì „ ë²„íŠ¼ -->
                    <li class="page-item" th:if="${currentPage > 0}">
                        <a class="page-link" th:href="@{/market-analysis(page=${currentPage - 1}, size=10)}">ì´ì „</a>
                    </li>

                    <!-- í˜ì´ì§€ ë²ˆí˜¸ -->
                    <li class="page-item" th:each="pageNum : ${#numbers.sequence(startPage, endPage)}"
                        th:classappend="${pageNum == currentPage} ? 'active'">
                        <a class="page-link" th:href="@{/market-analysis(page=${pageNum}, size=10)}"
                           th:text="${pageNum + 1}"></a>
                    </li>

                    <!-- ë‹¤ìŒ ë²„íŠ¼ -->
                    <li class="page-item" th:if="${currentPage < totalPages - 1}">
                        <a class="page-link" th:href="@{/market-analysis(page=${currentPage + 1}, size=10)}">ë‹¤ìŒ</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!--footer-->
<footer th:replace="fragments/footer :: footer"></footer>

<!--Javascript-->
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!--chart.js-->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", () => {

        // ì±—ë´‡
        const floatingButton = document.getElementById("chat-floating-button");
        const chatContainer = document.getElementById("chat-container");
        const closeChatButton = document.getElementById("close-chat");
        const chatForm = document.getElementById("chat-form");
        const chatInput = document.getElementById("chat-input");
        const sendButton = document.getElementById("send-button");
        const chatMessages = document.getElementById("chat-messages");

        // í”Œë¡œíŒ… ë²„íŠ¼ í´ë¦­ ì‹œ ì±„íŒ…ì°½ í† ê¸€
        floatingButton.addEventListener("click", () => {
            chatContainer.style.display = chatContainer.style.display === "none" ? "block" : "none";
        });

        // ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ì±„íŒ…ì°½ ìˆ¨ê¸°ê¸°
        closeChatButton.addEventListener("click", () => {
            chatContainer.style.display = "none";
        });

        // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
        function sendMessage() {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            addMessage("user", userMessage);

            // ë¡œë”© ì¤‘ ë©”ì‹œì§€ í‘œì‹œ (ì•„ì´ì½˜ í¬í•¨)
            const loadingMessage = addMessage("bot", '<span class="loading-icon"></span> ë¡œë”© ì¤‘...');

            // API ìš”ì²­
            fetch("/rag/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    user_id: "1", // ì‹¤ì œ ì‚¬ìš©ì IDë¡œ êµì²´ í•„ìš”
                    user_question: userMessage
                })
            })
                .then(response => response.json())
                .then(data => {
                    // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                    removeMessage(loadingMessage);

                    // ì„œë²„ ì‘ë‹µ ë°ì´í„° í‘œì‹œ
                    const { answer, title, article_date, company, url } = data;
                    addMessage("bot", `${answer}`);
                    if (title) {
                        addMessage("bot", `ê´€ë ¨ ê¸°ì‚¬: ${title} (${company}, ${article_date}) <a href="${url}" target="_blank">[ë§í¬]</a>`);
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    removeMessage(loadingMessage);
                    addMessage("bot", "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                });

            // ì…ë ¥ì°½ ë¹„ìš°ê¸°
            chatInput.value = "";
        }

        // ì „ì†¡ ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ì‹œì§€ ì „ì†¡
        sendButton.addEventListener("click", sendMessage);

        // ì—”í„° í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
        chatInput.addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                sendMessage();
            }
        });

        // ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
        function addMessage(sender, message) {
            const messageBubble = document.createElement("div");
            messageBubble.style.marginBottom = "10px";
            messageBubble.style.padding = "10px";
            messageBubble.style.borderRadius = "10px";

            if (sender === "user") {
                messageBubble.style.backgroundColor = "#d1ecf1";
                messageBubble.style.alignSelf = "flex-end";
            } else {
                messageBubble.style.backgroundColor = "#f8f9fa";
                messageBubble.style.alignSelf = "flex-start";
            }

            messageBubble.innerHTML = message;
            chatMessages.appendChild(messageBubble);
            chatMessages.scrollTop = chatMessages.scrollHeight; // ìŠ¤í¬ë¡¤ì„ ìµœì‹  ë©”ì‹œì§€ë¡œ ì´ë™
            return messageBubble; // ë©”ì‹œì§€ ì—˜ë¦¬ë¨¼íŠ¸ ë°˜í™˜
        }

        // ë©”ì‹œì§€ë¥¼ ì œê±°í•˜ëŠ” í•¨ìˆ˜
        function removeMessage(messageElement) {
            if (messageElement && messageElement.parentNode) {
                messageElement.parentNode.removeChild(messageElement);
            }
        }


    // ë¶€ë™ì‚° ì§€í‘œ
        // Springì—ì„œ ì „ë‹¬ëœ JSON ë°ì´í„°ë¥¼ ì½ê¸°
        const apiResultsJson = /*[[${apiResultsJson ?: '[]'}]]*/ '[]';
        console.log("Raw JSON:", apiResultsJson);

        let apiResults = [];
        try {
            apiResults = JSON.parse(apiResultsJson);
            console.log("Parsed JSON:", apiResults);

            if (apiResults.length === 0) {
                console.warn("No API results found.");
            }
        } catch (e) {
            console.error("Error parsing JSON:", e.message);
            apiResults = [];
        }

// ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
        const chartDatasets = apiResults.flatMap((apiResult, index) => {
            const { data } = apiResult;

            return data.map(item => ({
                x: item.PRD_DE, // ê¸°ê°„ (ì˜ˆ: 201411)
                y: parseFloat(item.DT) || 0 // ì§€í‘œ ê°’
            }));
        });

        if (chartDatasets.length === 0) {
            console.warn("No chart data available.");
        }

// ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        const ctx = document.getElementById("marketChart").getContext("2d");
        new Chart(ctx, {
            type: "line",
            data: {
                datasets: [{
                    label: "ë¶€ë™ì‚° ì§€í‘œ",
                    data: chartDatasets,
                    borderColor: "blue",
                    fill: false
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: "time",
                        time: {
                            unit: "month",
                            displayFormats: {
                                month: "YYYY-MM"
                            }
                        },
                        title: {
                            display: true,
                            text: "ê¸°ê°„"
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: "ì§€í‘œ ìˆ˜ì¹˜"
                        }
                    }
                }
            }
        });

        // ë‚ ì”¨ ì§€ë„
        // GeoJSON ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì§€ë„ì— ë‚ ì”¨ ì •ë³´ë¥¼ ì‹œê°í™”
        d3.json('/market-analysis/geojson-weather').then(data => {
            const svgElement = document.getElementById("weatherMap");
            const width = svgElement.clientWidth; // SVG ìš”ì†Œì˜ ì‹¤ì œ ë„ˆë¹„ë¥¼ ê°€ì ¸ì˜´
            const height = svgElement.clientHeight; // SVG ìš”ì†Œì˜ ì‹¤ì œ ë†’ì´ë¥¼ ê°€ì ¸ì˜´

            // SVG ë° ê·¸ë£¹ ìš”ì†Œ ìƒì„±
            const svg = d3.select("#weatherMap").attr("width", width).attr("height", height);
            const g = svg.append("g");

            // ì§€ë„ íˆ¬ì˜ ì„¤ì •
            const projection = d3.geoMercator().fitSize([width, height], data);
            const pathGenerator = d3.geoPath().projection(projection);

            // ì¤Œ ì„¤ì •
            const zoom = d3.zoom()
                .scaleExtent([20, 50])
                .on("zoom", event => g.attr("transform", event.transform));

            svg.call(zoom);

            // ìƒ‰ìƒ ìŠ¤ì¼€ì¼
            const weatherColorScale = d3.scaleOrdinal()
                .domain(["â˜€ï¸", "â˜ï¸", "ì •ë³´ ì—†ìŒ"])
                .range(["#FFD700", "#87CEEB", "#CCCCCC"]);

            // ì§€ë„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            const updateMap = (regionCode) => {
                const filteredFeatures = regionCode
                    ? data.features.filter(feature => feature.properties.SIG_CD.startsWith(regionCode))
                    : data.features;

                g.selectAll("path").remove(); // ê¸°ì¡´ ê²½ë¡œ ì œê±°

                g.selectAll("path")
                    .data(filteredFeatures)
                    .enter()
                    .append("path")
                    .attr("d", pathGenerator)
                    .attr("fill", d => {
                        const weather = d.properties.weather || "ì •ë³´ ì—†ìŒ";
                        return weatherColorScale(weather);
                    })
                    .attr("stroke", "white")
                    .attr("stroke-width", 0.5)
                    .on("mouseover", function (event, d) {
                        const weather = d.properties.weather || "ì •ë³´ ì—†ìŒ";
                        const changeRate = d.properties.ë³€ë™ë¥  || "N/A";
                        d3.select(this).attr("stroke", "black").attr("stroke-width", 1);
                        showTooltip(event, `<div style="text-align:center;">
                    <span style="font-size:20px;">${weather}</span><br>
                    ${d.properties.SIG_KOR_NM}<br>
                    ë³€ë™ë¥ : ${changeRate}
                </div>`);
                    })
                    .on("mouseout", function () {
                        d3.select(this).attr("stroke", "white").attr("stroke-width", 0.5);
                        hideTooltip();
                    });

                // ì¤Œ ë° ì´ë™
                if (regionCode) {
                    const bounds = pathGenerator.bounds({ type: "FeatureCollection", features: filteredFeatures });
                    const dx = bounds[1][0] - bounds[0][0];
                    const dy = bounds[1][1] - bounds[0][1];
                    const x = (bounds[0][0] + bounds[1][0]) / 2;
                    const y = (bounds[0][1] + bounds[1][1]) / 2;
                    const scale = Math.max(1, Math.min(8, 0.9 / Math.max(dx / width, dy / height)));
                    const translate = [width / 2 - scale * x, height / 2 - scale * y];

                    svg.transition().duration(750).call(
                        zoom.transform,
                        d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
                    );
                } else {
                    svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
                }
            };

            // ì§€ì—­ ë²„íŠ¼ ìƒì„±
            const regions = [
                { name: "ì„œìš¸íŠ¹ë³„ì‹œ", code: "11" },
                { name: "ë¶€ì‚°ê´‘ì—­ì‹œ", code: "26" },
                { name: "ëŒ€êµ¬ê´‘ì—­ì‹œ", code: "27" },
                { name: "ì¸ì²œê´‘ì—­ì‹œ", code: "28" },
                { name: "ê´‘ì£¼ê´‘ì—­ì‹œ", code: "29" },
                { name: "ëŒ€ì „ê´‘ì—­ì‹œ", code: "30" },
                { name: "ìš¸ì‚°ê´‘ì—­ì‹œ", code: "31" },
                { name: "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", code: "36" },
                { name: "ê²½ê¸°ë„", code: "41" },
                { name: "ê°•ì›ë„", code: "51" },
                { name: "ì¶©ì²­ë¶ë„", code: "43" },
                { name: "ì¶©ì²­ë‚¨ë„", code: "44" },
                { name: "ì „ë¼ë¶ë„", code: "45" },
                { name: "ì „ë¼ë‚¨ë„", code: "46" },
                { name: "ê²½ìƒë¶ë„", code: "47" },
                { name: "ê²½ìƒë‚¨ë„", code: "48" },
                { name: "ì œì£¼íŠ¹ë³„ìì¹˜ë„", code: "50" }
            ];

            const buttonContainer = d3.select("#buttonContainer");

// ì „êµ­ ë²„íŠ¼ ì¶”ê°€
            buttonContainer.append("button")
                .attr("class", "btn btn-primary btn-sm m-2")
                .html('<i class="fas fa-globe"></i> ì „êµ­')
                .on("click", () => updateMap(""));

// ì§€ì—­ë³„ ë²„íŠ¼ ì¶”ê°€
            regions.forEach(region => {
                buttonContainer.append("button")
                    .attr("class", "btn btn-outline-primary btn-sm m-2")
                    .html(`<i class="fas fa-map-marker-alt"></i> ${region.name}`)
                    .on("click", () => updateMap(region.code));
            });

            // ì´ˆê¸° ì§€ë„ ë Œë”ë§
            updateMap("");

            // íˆ´íŒ í‘œì‹œ
            const tooltip = d3.select("body")
                .append("div")
                .attr("class", "tooltip")
                .style("position", "absolute")
                .style("background", "rgba(0,0,0,0.7)")
                .style("color", "#fff")
                .style("padding", "5px")
                .style("border-radius", "5px")
                .style("visibility", "hidden");

            function showTooltip(event, content) {
                tooltip.html(content)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY + 10) + "px")
                    .style("visibility", "visible");
            }

            function hideTooltip() {
                tooltip.style("visibility", "hidden");
            }

        }).catch(error => {
            console.error("Error loading GeoJSON or weather data:", error);
        });

    });

</script>
<!-- ì‚¬ìš©ì ì •ì˜ JS -->
<script th:src="@{/js/home.js}"></script>
<th:block th:replace="fragments/header :: scripts"></th:block>
</body>
</html>